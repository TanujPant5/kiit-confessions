<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIIT Confessions // TRON</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font 'Orbitron' for Tron theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

    <!-- Custom Styles for Tron Theme -->
    <style>
        /* Base styling */
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0a1a;
            /* Dark blue/black */
            color: #00e5ff;
            /* Neon blue */
            text-shadow: 0 0 5px #00e5ff, 0 0 10px #00e5ff;
        }

        /* Helper for glowing effect */
        .glow {
            text-shadow: 0 0 5px #00e5ff, 0 0 10px #00e5ff, 0 0 15px #00e5ff;
        }

        /* Neon Borders */
        .neon-border {
            border: 2px solid #00e5ff;
            box-shadow: 0 0 10px #00e5ff, 0 0 15px #00e5ff inset;
            border-radius: 0.5rem;
            /* 8px */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #00e5ff;
            border-radius: 4px;
            box-shadow: 0 0 5px #00e5ff;
        }

        /* Textarea and Button Styling */
        textarea,
        button {
            font-family: 'Orbitron', sans-serif;
            background-color: rgba(0, 229, 255, 0.05);
            /* Faint blue */
            border: 1px solid #00e5ff;
            color: #00e5ff;
            text-shadow: 0 0 5px #00e5ff;
            transition: all 0.3s ease;
        }

        textarea::placeholder {
            color: #00e5ff;
            opacity: 0.5;
        }

        textarea:focus {
            outline: none;
            background-color: rgba(0, 229, 255, 0.1);
            box-shadow: 0 0 10px #00e5ff;
        }

        button:hover {
            background-color: #00e5ff;
            color: #0a0a1a;
            text-shadow: none;
            box-shadow: 0 0 15px #00e5ff;
        }

        /* Style for text input */
        input[type="text"] {
            font-family: 'Orbitron', sans-serif;
            background-color: rgba(0, 229, 255, 0.05);
            /* Faint blue */
            border: 1px solid #00e5ff;
            color: #00e5ff;
            text-shadow: 0 0 5px #00e5ff;
            transition: all 0.3s ease;
        }

        input[type="text"]::placeholder {
            color: #00e5ff;
            opacity: 0.5;
        }

        input[type="text"]:focus {
            outline: none;
            background-color: rgba(0, 229, 255, 0.1);
            box-shadow: 0 0 10px #00e5ff;
        }


        /* Feed container */
        #feedContainer {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #00e5ff;
            box-shadow: 0 0 10px #00e5ff inset;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Individual message bubbles */
        .message-bubble {
            background-color: rgba(30, 30, 50, 0.7);
            /* Dark grey-blue */
            border: 1px solid #007a8a;
            /* Darker cyan */
            text-shadow: 0 0 3px #00e5ff;
            word-wrap: break-word;
            /* Ensure long words break */
            white-space: pre-wrap;
            /* Respect newlines */
        }

        /* "My" message bubbles */
        .my-message {
            background-color: rgba(0, 50, 100, 0.8);
            /* Dark blue */
            border: 1px solid #00e5ff;
            /* Bright cyan */
            align-self: flex-end;
        }

        /* Timestamp styling */
        .timestamp {
            font-size: 0.65rem;
            /* 10px */
            color: #00e5ff;
            opacity: 0.6;
            text-shadow: none;
            margin-top: 4px;
        }

        /* Navigation styling */
        .nav-item {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .nav-item.active,
        .nav-item:hover {
            opacity: 1;
            text-shadow: 0 0 5px #00e5ff, 0 0 10px #00e5ff;
            border-bottom-color: #00e5ff;
        }
    </style>
</head>

<body class="flex flex-col h-screen p-2 sm:p-4 max-w-4xl mx-auto gap-4">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-center p-4 neon-border gap-4">
        <h1 class="text-2xl sm:text-3xl font-bold glow text-center sm:text-left">KIIT CONFESSIONS</h1>
        <!-- Navigation -->
        <nav class="flex text-lg gap-4">
            <div id="navConfessions" class="nav-item">CONFESSIONS</div>
            <div id="navChat" class="nav-item active">CHAT</div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col gap-4 overflow-hidden">
        <!-- Feed Container -->
        <div id="feedContainer" class="flex-1 flex flex-col p-4 rounded-lg gap-3 overflow-y-auto">
            <!-- Messages will be injected here -->
            <div id="loading" class="text-center p-4">CONNECTING TO GRID...</div>
        </div>

        <!-- Username Setup -->
        <!-- Responsive: flex-col on mobile, sm:flex-row on desktop -->
        <div id="usernameSection" class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="usernameInput" placeholder="SET YOUR USERNAME..."
                class="flex-1 p-3 rounded-lg focus:outline-none w-full" />
            <button id="usernameButton" class="px-6 py-3 sm:py-2 rounded-lg font-bold w-full sm:w-auto">SET</button>
        </div>

        <!-- Input Forms (one for each page) -->
        <!-- Responsive: flex-col on mobile, sm:flex-row on desktop -->
        <form id="confessionForm" class="hidden flex-col sm:flex-row gap-3">
            <textarea id="confessionInput" rows="2"
                class="flex-1 p-3 rounded-lg resize-none focus:outline-none w-full"
                placeholder="TYPE YOUR CONFESSION... (SHIFT+ENTER FOR NEW LINE)" required></textarea>
            <button id="confessionButton" type="submit"
                class="px-6 py-3 sm:py-2 rounded-lg font-bold w-full sm:w-auto">CONFESS</button>
        </form>

        <!-- Responsive: flex-col on mobile, sm:flex-row on desktop -->
        <form id="chatForm" class="flex flex-col sm:flex-row gap-3">
            <textarea id="chatInput" rows="2"
                class="flex-1 p-3 rounded-lg resize-none focus:outline-none w-full"
                placeholder="TYPE YOUR MESSAGE... (SHIFT+ENTER FOR NEW LINE)" required></textarea>
            <button id="chatButton" type="submit"
                class="px-6 py-3 sm:py-2 rounded-lg font-bold w-full sm:w-auto">SEND</button>
        </form>
    </main>

    <!-- Footer -->
    <footer class="text-center text-xs opacity-50 pb-2">
        ANONYMOUS GRID // DISCONNECT ANYTIME
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            serverTimestamp,
            doc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // User's provided Firebase config for Vercel deployment
        const firebaseConfig = {
            apiKey: "AIzaSyCtFOOGfjbeLM-bAT5i2J601w9_95MQlxs",
            authDomain: "kiit-confessions.firebaseapp.com",
            projectId: "kiit-confessions",
            storageBucket: "kiit-confessions.firebasestorage.app",
            messagingSenderId: "844059847809",
            appId: "1:844059847809:web:98a8a39a3a33c2dd7d3180",
            measurementId: "G-2JRL8TMMV7"
        };


        // --- DOM Elements ---
        const feedContainer = document.getElementById('feedContainer');
        const loading = document.getElementById('loading');

        const navConfessions = document.getElementById('navConfessions');
        const navChat = document.getElementById('navChat');

        const confessionForm = document.getElementById('confessionForm');
        const confessionInput = document.getElementById('confessionInput');
        const confessionButton = document.getElementById('confessionButton');

        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatButton = document.getElementById('chatButton');

        // Username elements
        const usernameInput = document.getElementById('usernameInput');
        const usernameButton = document.getElementById('usernameButton');

        // --- App State ---
        let db;
        let auth;
        let currentUserId = null; // Store the anonymous user ID
        let currentUsername = 'Anonymous'; // Store the user's chosen name
        let confessionsCollection;
        let chatCollection;
        let unsubscribeConfessions = () => {};
        let unsubscribeChat = () => {};
        let currentPage = 'chat'; // Default to chat page

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                // Check if firebaseConfig has been pasted
                if (firebaseConfig.apiKey === "AIzaSyCtFOOGfjbeLM-bAT5i2J601w9_95MQlxs") {
                    console.log("Firebase config loaded.");
                } else {
                    // This error will show if the config is somehow still the placeholder
                    throw new Error("Firebase configuration is missing or incorrect.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user (anonymously)
                const userCredential = await signInAnonymously(auth);
                currentUserId = userCredential.user.uid;
                console.log("Firebase initialized and user signed in:", currentUserId);

                // Load username from Firestore
                await loadUsername();

                // Define collection paths (Simplified for Vercel)
                confessionsCollection = collection(db, 'confessions');
                chatCollection = collection(db, 'chat');

                // Start the application on the default page
                showPage(currentPage); // This will be 'chat'

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loading.textContent = "Error: Could not connect to the grid. Refresh page.";
                if (error.message.includes("api-key-not-valid")) {
                    loading.textContent = "Error: Firebase API Key is not valid. Check console.";
                }
            }
        }

        // --- Username Functions ---
        async function loadUsername() {
            if (!db || !currentUserId) return;
            const userDocRef = doc(db, 'users', currentUserId);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                currentUsername = userDoc.data().username;
            } else {
                currentUsername = 'Anonymous';
            }
            usernameInput.value = currentUsername === 'Anonymous' ? '' : currentUsername;
        }

        async function saveUsername() {
            const newUsername = usernameInput.value.trim();
            if (newUsername && newUsername !== currentUsername) {
                currentUsername = newUsername;
                const userDocRef = doc(db, 'users', currentUserId);
                try {
                    await setDoc(userDocRef, {
                        username: newUsername
                    }, {
                        merge: true
                    });
                    // Visual feedback
                    usernameButton.textContent = "SAVED!";
                    usernameInput.blur();
                    setTimeout(() => {
                        usernameButton.textContent = "SET";
                    }, 1500);
                } catch (error) {
                    console.error("Error saving username:", error);
                    usernameButton.textContent = "ERROR!";
                    setTimeout(() => {
                        usernameButton.textContent = "SET";
                    }, 1500);
                }
            } else if (newUsername) {
                // Same name, just give feedback
                usernameButton.textContent = "SAVED!";
                setTimeout(() => {
                    usernameButton.textContent = "SET";
                }, 1500);
            }
        }

        // --- Page Navigation ---
        function showPage(page) {
            currentPage = page;
            if (page === 'confessions') {
                navConfessions.classList.add('active');
                navChat.classList.remove('active');
                confessionForm.classList.remove('hidden');
                confessionForm.classList.add('flex');
                chatForm.classList.add('hidden');
                chatForm.classList.remove('flex');
                listenForConfessions(); // Re-attach listener and render
            } else {
                navChat.classList.add('active');
                navConfessions.classList.remove('active');
                chatForm.classList.remove('hidden');
                chatForm.classList.add('flex');
                confessionForm.classList.add('hidden');
                confessionForm.classList.remove('flex');
                listenForChat(); // Re-attach listener and render
            }
        }

        // --- Real-time Data Listeners ---
        function listenForConfessions() {
            unsubscribeChat(); // Stop listening to chat
            feedContainer.innerHTML =
                '<div id="loading" class="text-center p-4">LOADING CONFESSIONS...</div>';

            const q = query(collection(db, 'confessions'));
            unsubscribeConfessions = onSnapshot(q, (snapshot) => {
                const docs = snapshot.docs;
                // Sort client-side by timestamp (Oldest first)
                const sortedDocs = docs.sort((a, b) => {
                    const timeA = a.data().timestamp?.toDate() || 0;
                    const timeB = b.data().timestamp?.toDate() || 0;
                    return timeA - timeB; // Oldest first (newest at bottom)
                });
                renderFeed(sortedDocs, 'confessions');
            }, (error) => {
                console.error("Error listening to confessions:", error);
                loading.textContent = "Error loading confessions.";
            });
        }

        function listenForChat() {
            unsubscribeConfessions(); // Stop listening to confessions
            feedContainer.innerHTML =
                '<div id="loading" class="text-center p-4">LOADING CHAT...</div>';

            const q = query(collection(db, 'chat'));
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                const docs = snapshot.docs;
                // Sort client-side by timestamp (Oldest first)
                const sortedDocs = docs.sort((a, b) => {
                    const timeA = a.data().timestamp?.toDate() || 0;
                    const timeB = b.data().timestamp?.toDate() || 0;
                    return timeA - timeB; // Oldest first (newest at bottom)
                });
                renderFeed(sortedDocs, 'chat');
            }, (error) => {
                console.error("Error listening to chat:", error);
                loading.textContent = "Error loading chat.";
            });
        }

        // --- Render Function ---
        function renderFeed(docs, type) {
            feedContainer.innerHTML = ''; // Clear feed
            if (docs.length === 0) {
                loading.textContent = `NO ${type.toUpperCase()} YET. BE THE FIRST!`;
                feedContainer.appendChild(loading);
                return;
            }

            docs.forEach(doc => {
                const data = doc.data();
                const text = data.text || '...';
                const time = data.timestamp ? data.timestamp.toDate().toLocaleString() : '...';
                const docUserId = data.userId; // Get the ID of the user who posted
                const username = data.username || 'Anonymous'; // Get username from doc

                // Check if this message is "mine"
                const isMine = currentUserId && docUserId === currentUserId;

                // Create wrapper for alignment
                const alignWrapper = document.createElement('div');
                alignWrapper.className = `flex w-full ${isMine ? 'justify-end' : 'justify-start'}`;

                // Create the message bubble
                const bubble = document.createElement('div');
                bubble.className = `message-bubble p-3 rounded-lg max-w-xs sm:max-w-md md:max-w-lg ${isMine ? 'my-message' : ''}`;

                // Create username element
                const usernameElement = document.createElement('div');
                usernameElement.className = `font-bold text-sm mb-1 opacity-70 ${isMine ? 'text-right' : 'text-left'}`;
                usernameElement.textContent = username;
                bubble.appendChild(usernameElement);

                // Create text content
                const textElement = document.createElement('p');
                textElement.textContent = text;
                bubble.appendChild(textElement);

                // Create timestamp
                const timeElement = document.createElement('div');
                timeElement.className = 'timestamp text-right';
                timeElement.textContent = time;
                bubble.appendChild(timeElement);

                alignWrapper.appendChild(bubble);
                feedContainer.appendChild(alignWrapper);
            });

            // Auto-scroll to bottom
            feedContainer.scrollTop = feedContainer.scrollHeight;
        }

        // --- Form Submission ---
        async function postConfession(e) {
            e.preventDefault();
            const text = confessionInput.value.trim();
            if (text && db) {
                try {
                    await addDoc(confessionsCollection, {
                        text: text,
                        timestamp: serverTimestamp(),
                        userId: currentUserId, // Tag with anonymous ID
                        username: currentUsername // Tag with username
                    });
                    confessionInput.value = '';
                } catch (error) {
                    console.error("Error adding confession: ", error);
                }
            }
        }

        async function postChatMessage(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (text && db) {
                try {
                    await addDoc(chatCollection, {
                        text: text,
                        timestamp: serverTimestamp(),
                        userId: currentUserId, // Tag with anonymous ID
                        username: currentUsername // Tag with username
                    });
                    chatInput.value = '';
                } catch (error) {
                    console.error("Error adding chat message: ", error);
                }
            }
        }

        // --- Event Listeners ---
        confessionForm.addEventListener('submit', postConfession);
        chatForm.addEventListener('submit', postChatMessage);
        navConfessions.addEventListener('click', () => showPage('confessions'));
        navChat.addEventListener('click', () => showPage('chat'));

        // Event listener for setting username
        usernameButton.addEventListener('click', (e) => {
            e.preventDefault();
            saveUsername();
        });
        usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveUsername();
            }
        });

        // Handle Enter/Shift+Enter for Confessions
        confessionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                // Manually trigger form submission
                confessionForm.requestSubmit(confessionButton);
            }
            // If Shift + Enter, default action (new line) is allowed
        });

        // Handle Enter/Shift+Enter for Chat
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                // Manually trigger form submission
                chatForm.requestSubmit(chatButton);
            }
            // If Shift + Enter, default action (new line) is allowed
        });

        // Start the application
        initFirebase();
    </script>

</body>

</html>